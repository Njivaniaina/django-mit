{% extends "login/base.html" %}

{% block content %}

<div class="flex justify-center mt-32">
<div class="flex flex-col w-3xl rounded-8 p-6">
<div class="w-full h-fit flex items-center justify-center">

<div class="w-sm bg-base-200 p-6 space-y-4 rounded-2xl shadow-xl">
  <h1 class="text-3xl font-bold text-center text-primary">Login</h1>

  {% if message %}
  <div role="alert" class="alert alert-error">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span>{{ message }}</span>
  </div>
  {% endif %}



  <!-- Formulaire login -->
  <form method="POST" class="space-y-4" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Username -->
    <div>{{ form.username }}</div>

    <!-- Password -->
    <div>{{ form.password1 }}</div>

    <!-- Bouton pour afficher la capture visage -->
    <button type="button" class="btn btn-neutral w-full" onclick="toggleFaceScan()">Scan Face</button>

    <!-- Champ vidéo pour Face Scan, caché par défaut -->
    <div id="face-scan-container" class="hidden space-y-2 mt-2">
      <video id="camera" autoplay class="rounded-lg w-full"></video>
      <button type="button" class="btn btn-primary w-full" onclick="captureLogin()"> Capturer et Login </button>
      <input type="hidden" name="face_scan" id="face_scan">
      <canvas id="canvas" class="hidden"></canvas>
    </div>

    <!-- Bouton classique -->
    <!-- <button type="submit" class="btn btn-primary w-full mt-2">Login</button> -->
  </form>

  <!-- Lien vers inscription -->
  <p class="text-center text-sm mt-2">
    Nouveau utilisateur ?
    <a class="btn btn-link" href="{% url 'sign_in' %}">Inscription</a>
  </p>
</div>

<script>
  let stream = null;

  // Afficher / cacher le scan visage
  function toggleFaceScan() {
    const container = document.getElementById("face-scan-container");
    container.classList.toggle("hidden");

    // Initialiser la caméra si le container devient visible
    if (!container.classList.contains("hidden") && !stream) {
      navigator.mediaDevices.getUserMedia({video: true})
        .then(s => {
          stream = s;
          document.getElementById("camera").srcObject = s;
        })
        .catch(err => console.error("Erreur caméra:", err));
    }
  }

  // Capture de l'image et envoi
  function captureLogin() {
    const video = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Stocker en Base64
    document.getElementById("face_scan").value = canvas.toDataURL("image/png");

    // Arrêter la caméra
    if (stream) stream.getTracks().forEach(track => track.stop());
    video.srcObject = null;

    // Soumettre automatiquement le formulaire
    document.querySelector("form").submit();
  }
</script>


</div>
</div>
</div>
{% endblock %}
